# CPU使用率优化总结

## 问题原因
1. Uvicorn服务使用了--reload选项，导致持续监控文件变化
2. 计算有效天数函数没有缓存，每次请求都重新计算
3. 监控脚本也使用了--reload选项，加剧了CPU使用

## 优化措施
1. 移除了所有启动脚本中的--reload选项：
   - restart.sh
   - monitor.sh
   - scripts/monitor.sh
   
2. 为计算密集型函数添加缓存：
   - 使用functools.lru_cache装饰器
   - 重构了calculate_valid_days函数，将其分为wrapper和实际实现
   - 转换不可哈希参数为可哈希类型，使缓存生效
   
3. 其他优化：
   - 降低了函数复杂度
   - 移除了不必要的自动周期创建逻辑（改为仅记录日志）
   - 增强了错误处理

## 结果
1. uvicorn进程CPU使用率从50%+降低到0.4%
2. 系统响应更快
3. 保持了相同的功能

## 建议
1. 在生产环境中从不使用--reload选项
2. 对计算密集型函数添加适当缓存
3. 定期检查系统资源使用情况 